version: '3'

vars:
  COMPOSE_FILE: docker/compose/build/compose.yaml

tasks:
  gen:
    desc: "Generate compose.yaml from jsonnet files"
    silent: true
    sources:
      - docker/compose/**/*
      - exclude: docker/compose/build/**
    generates:
      - "{{.COMPOSE_FILE}}"
    cmds:
      - echo -e "{{.OUTPUT}}" > {{.COMPOSE_FILE}}
    vars:
      RAW:
        sh: jsonnet -S docker/compose/main.jsonnet
      OUTPUT:
        sh: docker compose -f <(echo "{{.RAW}}") --project-directory . config
  clean:
    desc: "Delete compose.yaml generated by jsonnet files"
    preconditions:
      - test -f {{.COMPOSE_FILE}}
    cmds:
      - rm {{.COMPOSE_FILE}}
  internal-compose:
    internal: true
    deps:
      - gen
    cmds:
      - docker compose -f {{.COMPOSE_FILE}} --project-directory . {{.COMPOSE_CMD}}
  compose:
    desc: "Generate compose.yaml from jsonnet files and execute docker-compose (e.g.: task docker:compose -- ps)"
    cmds:
      - task: internal-compose
        vars:
          COMPOSE_CMD: "{{.CLI_ARGS}}"
